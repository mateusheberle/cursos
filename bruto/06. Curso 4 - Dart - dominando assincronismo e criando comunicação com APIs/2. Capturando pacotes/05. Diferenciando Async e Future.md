## Diferenciando Async e Future

Conversamos sobre o fluxo de execução ao utilizar um **`then()`** no Dart e como ele **agenda o bloco de código** dentro de si **para ser executado apenas quando o future termina**. Isso pode causar algumas situações, como a que estamos observando no nosso código, onde o retorno da mensagem "Última coisa a acontecer na função" é executado antes do retorno do saldo, escrito em linhas anteriores.

Isso ocorre, pois o retorno do saldo foi escrito dentro do `then()`, que só será processado quando o `future` acabar.

Embora seja uma ferramenta útil e interessante, há situações em que a própria regra de negócio aplicada na empresa ou **projeto exige aguardar a execução de uma linha antes de prosseguir** com qualquer outra.

No Dart, implementaremos isso em outra função. No arquivo `main.dart`, abaixo das chaves que encerram o bloco `requestData`, criaremos outra função para comparação, chamando-a de `requestDataAsync`.

Entre suas chaves, começaremos da mesma forma, copiando a `url` no início do bloco `requestData`. Na linha seguinte, faremos um `get()`, passando a URI com `URI.parse()` entre parênteses, e a `url` entre os parênteses desse `parse()`.

```dart
// main.dart:

requestData() async {
    // Código omitido
}

requestDataAsync() {
    String url = "https://gist.githubusercontent.com/ricarthlima/a0eb198cb7a70696c4031e7e577de0cd/raw/356ce2c39dfd58d3d2e948d1ad87ea828544f1db/accounts.json";
    get(Uri.parse(url));
}
```

O **sufixo `Async`** foi adicionado **como um indicativo de que a função é assíncrona**. A operação `get()` em seu interior é assíncrona e **retorna um future**.

Para garantir que a ordem seja respeitada e que o **código espere a execução antes de prosseguir**, utilizaremos o termo especial **`await`** antes dela.

**O `await` significa "espere"** e só pode ser usado em funções assíncronas. Ele deve ser posto logo **antes de uma função que retorna um future**, pois só faz sentido nesse contexto.

Para tornar a `requestDataAsync` uma função assíncrona, adicionamos `async` após os parênteses dos parâmetros.

```dart
requestDataAsync() async {
    String url = "https://gist.githubusercontent.com/ricarthlima/a0eb198cb7a70696c4031e7e577de0cd/raw/356ce2c39dfd58d3d2e948d1ad87ea828544f1db/accounts.json";
    await get(Uri.parse(url));
}
```

Ao declarar a **função como assíncrona**, informamos ao Dart e a quem for utilizá-la que ela **não fornecerá uma resposta instantânea**. O `await` **transforma o retorno de `future response` para `response`**, excluindo a necessidade de um objeto representado um futuro que, ao ser finalizado, usaria o `then()`.

**Com o `await`**, **o código avançará para a linha seguinte somente quando o `get()` terminar**, fornecendo a resposta. Portanto, podemos guardar esse `get()` num `Response` chamado `response`.

```dart
requestDataAsync() async {
    String url = "https://gist.githubusercontent.com/ricarthlima/a0eb198cb7a70696c4031e7e577de0cd/raw/356ce2c39dfd58d3d2e948d1ad87ea828544f1db/accounts.json";
    Response response = await get(Uri.parse(url));
}
```

Com esse `await`, temos a resposta numa única linha de código, com a condição de **não avançar para a próxima linha até finalizar** a execução do `get()`.

Assim, podemos fazer um `print(json.decode(response.body)[0])` na linha seguinte para mostrar que, ao invés de imprimir uma informação específica, como o balance, podemos **imprimir uma conta inteira**.

Para comparação, adicionaremos um `print()` na linha seguinte, indicando a mensagem "De fato, a última coisa a acontecer na função".

```dart
requestDataAsync() async {
    String url = "https://gist.githubusercontent.com/ricarthlima/a0eb198cb7a70696c4031e7e577de0cd/raw/356ce2c39dfd58d3d2e948d1ad87ea828544f1db/accounts.json";
    Response response = await get(Uri.parse(url));
    print(json.decode(response.body)[0]);
    print("De fato, a última coisa a acontecer na função.");
}
```

Por fim, executaremos a `requestDataAsync()`, adicionando-a entre as chaves do `main`, comentando a `requestData()` executada anteriormente.

```dart
void main() {
    // print("Olá, mundo!");
    //requestData();
    requestDataAsync();
}
```

Salvaremos o código. Ao executá-lo no terminal com `dart run bin/main.dart`, este imprimirá a primeira conta e, em seguida, a última operação da função.

```
{id: ID001, name: Ricarht, lastName: Lima, balance: 113.0}

De fato, a última coisa a acontecer na função.
```

Com isso, o código se torna mais simples e direto, respeitando a ordem de execução. Apesar de ser **mais adequado do que o `then()`** neste código, ambos são úteis e devem ser aplicados conforme o contexto.

### Próximos passos

Após implementar o `then()` e o `Await`, duas ferramentas poderosas, prosseguiremos na construção do nosso programa de banco.

