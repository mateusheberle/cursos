## Criando os cabeçalhos da requisição

Estamos com nossa chave de API em mãos. *Mas como fazemos para enviar a informação e, finalmente, atualizar o `accounts.json`?*

Exemplo em cURL para atualizar gist

```curl
curl -L \
  -X PATCH \
  -H "Accept: application/vnd.github+json" \
  -H "Authorization: Bearer <YOUR-TOKEN>" \
  -H "X-GitHub-Api-Version: 2022-11-28" \
  https://api.github.com/gists/GIST_ID \
  -d '{"description":"An updated gist description","files":{"README.md":{"content":"Hello World from GitHub"}}}'
```

### Entendendo o cabeçalho da requisição

Vamos notar alguns detalhes. Primeiro, **precisamos passar o token em um tal de H**.Esse H vem do inglês **header**, que significa **cabeçalho**.

**Um cabeçalho no HTTP são informações sobre o que queremos enviar ou sobre o que recebemos**, mas não o que, de fato, enviamos ou recebemos. Pode parecer irrelevante, mas é importantíssimo. **É nesse lugar que colocaremos nossa API key** para fazer a autorização. Isso é algo que aprendemos com esse exemplo.

### Link

Outra coisa é o link. **O link é `https://api.github.com/gists/gist_id`**. Isso não é igual à nossa URL na linha 49 do nosso VSCode. Sabe por quê? Porque essa linha era uma visualização de navegador que aproveitamos para ler de forma mais direta no nosso programa.

Mas agora, não adianta visualizar, queremos alterar. Para isso, **precisamos usar a URL certa!**

### Respeitando a estrutura do corpo da requisição

Além disso, **não podemos enviar no corpo diretamente o conteúdo do arquivo**. Existem algumas coisas que precisamos respeitar. Por exemplo, **precisamos passar um map que terá uma descrição**. Dentro desse map, teremos os files, ou seja, **os arquivos que queremos enviar**, e dentro desses files haverá **outro map que conterá o arquivo que queremos atualizar e seu conteúdo**.

Vai ficar mais claro, mas é importante ter em mente que vamos **mudar essas três coisas**.

### Preparando a nova URL para a requisição

Vamos começar mudando a URL. Para mudar a URL, temos uma dica: vamos até o gist que queremos alterar e **copiar a URL que está no gist**. Vamos copiar a URL do gist e colar substituindo a string. Vamos fazer algumas alterações para que isso se ajuste ao que a documentação da API pede.

**Ao invés de `gist`**, que é para visualização em navegador, vamos **mudar para `api.github.com`**. E, ao **invés do seu nome de usuário**, vamos **mudar para `gists`**.

```dart
String url = "https://api.github.com/gists/413c0aefe6c6abc464581c29029c8ace";
```

Pronto. Conseguimos mudar a URL de visualização no navegador para o **padrão de API que o gist do GitHub exige**. Vale dizer que isso pode mudar. Padrões de API podem mudar com atualizações. É raro um servidor ou endpoints mudarem, mas é importante estar ciente disso. **Vamos salvar**.

### Configurando os cabeçalhos de autenticação

O próximo passo é **colocar um cabeçalho nesse post** que será salvo na resposta.

Para colocar o cabeçalho, vamos lembrar que, quando demos aquele *contra + espaço* depois da URI, havia também, além do body, os headers. E esses cabeçalhos passaremos em forma de map. Vamos salvar só para ele identar.

O que **vamos passar dentro do headers é uma autorização**. Então, **a chave desse cabeçalho é** **Authorization**.

Precisamos **seguir o padrão que está na documentação**. Então, se formos à documentação, não é só jogar o token. Tem um termo antes, `Bearer`. Vamos copiar esse termo com o espaço.

Esse cabeçalho de autorização pode receber diferentes tipos de tokens. O GitHub exige que sigamos esse padrão de autorização dizendo que **nosso token segue esse `Bearer` que vem antes**. Em seguida, **basta chamarmos por interpolação o `$githubApiKey`**.

```dart
String url = "https://api.github.com/gists/413c0aefe6c6abc464581c29029c8ace";

Response response = await post(
  Uri.parse(url),
  headers: {
    "Authorization" : "Bearer $githubApiKey"
  },
  body: content,
);

print(response.statusCode);
```

### Montando o corpo da requisição

A última coisa que falta é mudar esse corpo. Lembra que **não podemos mandar só o conteúdo**. **Precisamos mandar algumas informações sobre o que queremos editar**. Essas informações são indicadas também na documentação. Então, é uma descrição. Depois, temos os `files`. Vamos passar nosso arquivo contendo um map com o `content`.

Para fazer isso, primeira coisa: sabemos que **o body do nosso HTTP precisa receber uma string formatada**. Então, vamos tirar o `body: content` e colocar um `body: json.encode()`. Agora sim, **podemos criar um map dentro dele**.

**Esse map terá uma description**. Vamos colocar uma chave para dizer que ele é público. Então, vamos colocar **`public` na linha 58, como `true`**. Vamos colocar também o que ele nos pediu, que são os files. Quais são os arquivos que estamos alterando aqui? Esse files recebe um map.

Esse map, **para cada um dos arquivos que queremos alterar, colocamos uma chave nova**. No caso, queremos alterar apenas um arquivo. Então, vamos colocar aqui `accounts.json`. Queremos mudar o `content` dele. Então, abrimos mais um map e colocamos aqui o `content`. Será, finalmente, nosso `content` que acabamos de gerar lá em cima.

```dart
sendDataAsync(Map<String, dynamic> mapAccount) async {
  List<dynamic> listAccounts = await requestDataAsync();
  listAccounts.add(mapAccount);
  String content = json.encode(listAccounts);

  String url = "https://api.github.com/gists/413c0aefe6c6abc464581c29029c8ace";

  Response response = await post(
    Uri.parse(url),
    headers: {"Authorization": "Bearer $githubApiKey"},
    body: json.encode({
      "description": "account.json",
      "public": true,
      "files": {
        "accounts.json": {
          "content": content,
        }
      }
    }),
  );
  print(response.statusCode);
}
```

**Vamos salvar**. E agora sim, temos uma requisição do jeito que a documentação pediu.

### Recapitulando

Vamos recapitular. O que a documentação pediu?

Primeiro, **não podemos usar aquela URL de navegador. Temos que usar o padrão `api.github.com/gists` e passar o ID.** Passamos essa URL. Ótimo.

Nos cabeçalhos, precisamos provar que somos nós. Para fazer isso, como só nós pudemos gerar aquela chave, passamos essa chave que é única. **Usando a chave do map `Authorization` e passando `githubApiKey` como um valor**.

E no **corpo da requisição**, temos que, primeiro, **passar um map**. Mas, como sabemos que temos que trafegar isso via JSON, fazemos a conversão usando o `json.encode`. Dentro desse `json.encode`, passamos um map contendo a descrição. Escolhemos colocar apenas o nome. Queremos manter nosso arquivo como público. Então, passamos a chave public como true.

Passamos dentro de files o `accounts.json`, mudando seu `content`. Poderíamos mudar outras coisas além de content, como o título, por exemplo. Mas queremos mudar o conteúdo para o que estava em content, que é nossa lista alterada com um elemento a mais.

### Testando a requisição no terminal

Vamos ver isso funcionando agora.

No terminal, podemos rodar o comando de execução e ver o que acontece.

```sh
dart run bin/main.dart
```
```
200
```

Ele retornou 200! Lembra que estávamos imprimindo o status code? E lembra que falamos que se ele está entre 200 e 299 **é porque deu certo**?

Então, vamos ao nosso gist. Vamos abrir ele e atualizar. Algo mudou. Beleza! Ele perdeu aquela formatação bonita. Tudo bem, mas ele ainda está com as cores. Quer dizer que ele está entendendo isso como um JSON. O que precisamos fazer é ir até o final e ver que a última entrada não é mais Isabel Almeida e sim a última coisa que adicionamos!

{"id":"NEW001","name":"Flutter","lastName":"Dart","balance":5000}

Funcionou! **Usando o post conseguimos fazer com que um dado chegasse ao nosso Git**.
