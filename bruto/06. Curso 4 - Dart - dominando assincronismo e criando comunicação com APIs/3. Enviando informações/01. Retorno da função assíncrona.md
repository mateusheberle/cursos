## Retorno da função assíncrona

Já conseguimos obter a informação usando a API, agora vamos **enviar uma nova informação**: adicionaremos uma nova conta à lista existente.

No VS Code, vamos criar um novo método chamado `sendDataAsync` no arquivo `main.dart`, seguindo o mesmo padrão que estamos utilizando. Diferente dos outros métodos, precisamos de alguma informação para enviar. Neste caso, vamos pedir por parâmetro um `Map<String, dynamic> mapAccount`. Estamos pedindo um map porque, como vimos no formato de JSON, os elementos estão em uma estrutura de map, com `name`, `lastName`, `balance`, entre outros. Portanto, é adequado usarmos um map aqui.

Em seguida, vamos **definir essa função como assíncrona**, pois sabemos que, ao enviar informação, **haverá um tempo de espera** até que ela chegue ao destino.

```dart
sendDataAsync(Map<String, dynamic> mapAccount) async {

}
```

### Como adicionar?

Precisamos pensar em como adicionar algo novo ao que já está lá, pois não temos uma forma de simplesmente enviar um elemento ou map.

Uma boa abordagem seria **baixar a lista inteira**, **convertê-la usando JSON** para uma lista, **adicionar um elemento a essa lista**, e depois **convertê-la de volta para uma string** e **enviá-la**.

Para isso, a primeira coisa a fazer é *solicitar tudo que está lá*.

Não faz sentido repetir todo o código para solicitar a lista que já está no *gist*, pois já fazemos isso na função `requestDataAsync`. Assim, vamos usar a função já existente e pedir que ela nos retorne o resultado.

Precisamos **definir o retorno da função** como uma lista de `dynamic`, que é o que acontece quando fazemos essa decodificação.

```dart
List<dynamic> requestDataAsync() async {
// código omitido
```

No entanto, a IDE está **indicando um erro** em `List<dynamic>` pois **funções assíncronas devem retornar um tipo que tenha como supertipo `Future`**.

Ao colocarmos o mouse sobre `List<dynamic>` aparece a seguinte mensagem:

```
Functions marked 'async' must have a return type which is a supertype of 'Future'. Try fixing the return type of the function, or removing the modifier 'async' from the function

body.dart(illegal_async_return_type)

abstract interface class List<E> implements Iterable<E>, _ListIterable<E>
```

Como nossa função é assíncrona, o retorno não será instantâneo, e quem lida com isso no Flutter é o `Future`. Portanto, **o retorno de uma função assíncrona deve ser um `Future`, independentemente do subtipo**.

Então vamos substituir por:

```dart
Future<List<dynamic>> requestDataAsync() async {
// código omitido
```

Agora, há um erro de retorno, pois está retornando nulo. Precisamos que **retorne um `Future` com a lista de `dynamic`**. Podemos deletar as linhas de print e colocar um `return json.decode(response.body)`:

Ao passar o mouse sobre o termo `decode`, vemos que ele é um `dynamic`, mas sabemos que nossa string virá formatada como JSON contendo uma lista na parte externa. Assim, **quando a função terminar, ela retornará um `Future` com essa lista**.

Dentro do `sendDataAsync` vamos pegar esse retorno:

```dart
sendDataAsync(Map<String, dynamic> mapAccount) async {
    List<dynamic> listAccounts = await requestDataAsync();
}
```

Agora, podemos executar nosso plano. Se temos uma lista onde cada elemento é uma conta existente, basta que `listAccounts` receba `.add(mapAccount)`. O último passo é converter essa lista de contas de volta para string.

```dart
sendDataAsync(Map<String, dynamic> mapAccount) async {
    List<dynamic> listAccounts = await requestDataAsync();
    listAccounts.add(mapAccount);
    String content = json.encode(listAccounts);
}
```

### Testando

Vamos imprimir para verificar se está funcionando.

```dart
sendDataAsync(Map<String, dynamic> mapAccount) async {
    List<dynamic> listAccounts = await requestDataAsync();
    listAccounts.add(mapAccount);
    String content = json.encode(listAccounts);
    print(content);
}
```

Para testar, vamos à `main`, comentar o `requestDataAsync`, pois ele está sendo executado internamente na nova função, e chamar `sendDataAsync`.

```dart
void main() {
  // print("Olá, mundo!");
  // requestData();
  // requestDataAsync();

  sendDataAsync();
}
```

O `sendDataAsync()` pede um map, que é o que queremos adicionar. Vamos criar um exemplo. Para isso, precisamos seguir os padrões que estão sendo usados no nosso Git, que seriam os padrões que usaríamos numa empresa, por exemplo. Esse será o exemplo que vamos utilizar:

```dart
void main() {
  // print("Olá, mundo!");
  // requestData();
  // requestDataAsync();

  sendDataAsync({
    "id": "NEW001",
    "name": "Flutter",
    "lastName": "Dart",
    "balance": 5000,
  });
}
```

Vamos salvar, acessar o terminal e rodar o arquivo:

```sh
dart run bin/main.dart
```
Após um tempo, vemos que todos os elementos estão lá, incluindo o último que adicionamos.

```
[ {"id":"ID001", "name":"Ricarth", "lastName":"Lima", "balance":113.0}, {"id":"ID002", "name":"Ana", "lastName":"Silva", "balance":250.0}, {"id":"ID003", "name":"Bruno", "lastName":"Santos", "balance":75.0}, {"id":"ID004", "name":"Carla", "lastName":"Oliveira", "balance":500.0}, {"id":"ID005", "name":"Daniel", "lastName":"Ferreira", "balance":180.0}, {"id":"ID006", "name":"Elisa", "lastName":"Costa", "balance":320.0}, {"id":"ID007", "name":"Fábio", "lastName":"Pereira", "balance":60.0}, {"id":"ID008", "name":"Gabriela", "lastName":"Rodrigues", "balance":200.0}, {"id":"ID009", "name":"Henrique", "lastName":"Martins", "balance":450.0}, {"id":"ID010", "name":"Isabela", "lastName":"Almeida", "balance":210.0}, {"id":"NEW001", "name":"Flutter", "lastName":"Dart", "balance":5000} ]
```

### Próximo passo

Já temos a string que precisamos enviar, basta enviá-la. Vamos fazer isso no próximo vídeo!